import { Meta } from '@storybook/addon-docs';

<Meta title="User Guide/Configuration" />

# Configuration

Basically, you are free how to configure the OeREB Client. All you need
to do is updating the settings dictionary of the Pyramid configuration.
This dictionary has to be extended with an `oereb_client` element that
contains the parameters described below.

It's recommended to use a YAML file, as described in the next section,
but you don't have to.

## Update the Pyramid configuration

> **Note:** This section is not necessary, if the application is run using
the provided container image.

In this example, the configuration file for the OeREB Client is named
`oereb_client.yml`. You can create this file in your application's root
directory.

The next step is to define this file in your application's INI file. For
example, open the *development.ini* file and add the following line
within the *app:main* section:

```
oereb_client.cfg = %(here)s/oereb_client.yml
```

You can call it whatever you want, but it makes sense to use the package
name. You could also use an already existing file, e.g. from
`pyramid_oereb`. The variable `%(here)s` stands for the root directory
and will be replaced by its absolute path.

As you've now defined, where your configuration file is placed, you can
parse its content. Open the `__init__.py` of your application and apply
the follow changes:

1. Add the required imports at the top of the file.

```python
import codecs
import yaml
```

2. Update your `main` method to read and parse the configuration file.
   The location of the configuration is available in the existing
   settings dictionary (from the INI file). To read the configuration,
   it's recommended to use the `codecs` library to avoid errors due to
   special characters. The file content gets parsed using the `yaml`
   library and directly applied onto the settings dictioinary.

```python
def main(global_config, **settings):
    """
    This function returns a Pyramid WSGI application.
    """
    config = Configurator(settings=settings)
    settings = config.get_settings()
    with codecs.open(settings.get('oereb_client.cfg'), encoding='utf-8') as f:
        settings.update(yaml.load(f.read()).get('vars'))
    ...
    config.scan()
    return config.make_wsgi_app()
```

Now everything is set up to configure the OeREB Client.

## Configure the OeREB Client

Add your configuration in the created `oereb_client.yml` or mount this file into
your container. The top-level element has to be called `oereb_client`. The
following example shows such a configuration and explains the parameters.

```yaml
# OeREB Client
oereb_client:

  # Global application configuration
  # Mandatory:
  #   - title                 The multilingual application title
  #   - logo_canton           Multilingual URL of the cantonal logo
  #   - languages             List of the available languages
  #   - default_language      The language used as default
  # Optional:
  #   - icon                  URL to image used as favicon
  #   - logo_oereb            Multilingual URL of the oereb logo
  #   - local_storage_prefix  Prefix used for the local browser storage
  # Logos and Titles have to be provided in each configured language.
  application:
    title:
      - Language: en
        Text: PLR Cadastre
      - Language: de
        Text: ÖREB-Kataster
      - Language: fr
        Text: Cadastre RDPPF
    logo_canton:
      - Language: en
        URL: https://example.com/my_cantonal_logo_en.png
      - Language: de
        URL: https://example.com/my_cantonal_logo_de.png
      - Language: fr
        URL: https://example.com/my_cantonal_logo_fr.png
    languages:
      - en
      - de
      - fr
    default_language: en
    icon: https://example.com/my_favicon.png
    logo_oereb:
      - Language: en
        URL: https://example.com/my_oereb_logo_en.png
      - Language: de
        URL: https://example.com/my_oereb_logo_de.png
      - Language: fr
        URL: https://example.com/my_oereb_logo_fr.png
    local_storage_prefix: myPrefix

  # The view configuration for Openlayers.
  # You can define the default initial extent via the map center (map_x
  # and map_y) and the zoom level (map_zoom).
  # Optionally, you can also restrict the resolutions.
  view:
    map_x: 2615000
    map_y: 1255000
    map_zoom: 2
    resolutions: [250, 100, 50, 20, 10, 5, 2.5, 2, 1.5, 1, 0.5, 0.25, 0.1, 0.05, 0.025, 0.01]

  # A base layer has to be defined. You have two options: WMS and WMTS.
  # The "params" attribute in the WMS configuration allows all values
  # according to the ol.source.ImageWMS documentation:
  # https://openlayers.org/en/v4.2.0/apidoc/ol.source.ImageWMS.html
  #
  # WMS configuration:
  #   type: wms
  #   url: https://example.com/wms
  #   params:
  #     LAYERS: layer1,layer2
  #     FORMAT: image/png
  #
  # WMTS configuration:
  #   type: wmts
  #   url: https://example.com/wmts/1.0.0/capabilities.xml
  #   layer: my_base_map
  #   matrixSet: swissgrid
  #   projection: "EPSG:2056"
  #   style: default
  #   format: image/png
  #
  base_layer:
    type: wmts
    url: https://example.com/wmts/1.0.0/capabilities.xml
    layer: my_base_map
    matrixSet: swissgrid
    projection: "EPSG:2056"
    style: default
    format: image/png

  # The availability layer can be used to display an overview of the
  # available/published municipalities. You have to define a WMS URL and
  # params according to the ol.source.ImageWMS documentation:
  # https://openlayers.org/en/v4.2.0/apidoc/ol.source.ImageWMS.html
  # At least "LAYERS" has to be defined.
  availability:
    url: https://example.com/wms
    params:
      LAYERS: oereb_published_municipalities
      FORMAT: image/png

  # OeREB web service base URL (optional)
  # This parameter is only needed, if you are running your OeREB web
  # service in a separate application/container with a different base URL.
  # Do not use this parameter, if you are including the OeREB Client as a
  # plugin in an existing pyramid_oereb instance.
  service_url: https://my.oereb-web-service.ch/

  # Search configuration
  # Specify a list to use the internal search proxy or an URL to use an external endpoint.
  # search: https://my.search-endpoint.ch/
  # Each entry needs a multilingual title. The defined parameters can be used in the URL.
  # The parameter {term} is always available and contains the current search value.
  search:
    - title:
        - Language: en
          Text: E-GRID
        - Language: de
          Text: E-GRID
      url: https://example.com/search?query={prefix}+{term}&limit={limit}
      params:
        limit: 5
        prefix: egr
      hook_method: my.package.hook_egrid
      # Optional parameter to disable certificate verification (enabled by default)
      verify_certificate: False
    - title:
        - Language: en
          Text: Address
        - Language: de
          Text: Adresse
      url: https://example.com/search?query=adr+{term}&limit=5&foo=bar
      hook_method: samples.search.hook_address
    - title:
        - Language: en
          Text: Real estate
        - Language: de
          Text: Grundstück
      url: https://example.com/search?query={prefix}+{term}&limit={limit}
      params:
        limit: 5
        prefix: gs
      hook_method: samples.search.hook_real_estate

  # Link to external viewer/portal
  # Use this parameter to configure the link to an external viewer or
  # portal. The defined URL gets opened in a new tab. The list of
  # parameters gets joined with "&" and is appended to the URL. You
  # can add special keywords, e.g. "{egrid}", that are replaced by the
  # current values of the real estate and the map. The available
  # keywords are:
  # - map_x             Center of map (X value)
  # - map_y             Center of map (Y value)
  # - map_zoom          Map zoom level
  # - lang              Currently selected language
  # - egrid             EGRID of current real estate
  # - canton            Canton of current extract
  # - fosnr             FOS number of current municipality
  # - identdn           Ident DN of current real estate
  # - municipality      Current municipality name
  # - number            Number of current real estate
  external_viewer:
    tooltip:
      - Language: en
        Text: Go to external viewer
      - Language: de
        Text: zu externem Viewer wechseln
    url: https://my.webgis.com
    params:
      - "egrid={egrid}"
      - "foo=bar"

  # Your support address. This will be shown if an error occurs.
  support:
    office1:
      - Language: en
        Text: My Department
      - Language: de
        Text: Meine Direktion
    office2:
      - Language: en
        Text: My Office
      - Language: de
        Text: Meine Dienststelle
    street: Street 1a
    city: 1234 City
    email: support@example.com
    phone: 061 123 45 67

  # Custom CSS file
  # Add the URL to a custom CSS file to adjust styles.
  custom_css_url: https://example.com/mystyle.css

  # Enable Google Analytics by specifying account key. Leave this
  # parameter undefined to disable Google Analytics.
  google_analytics: UA-12345678-9
```
